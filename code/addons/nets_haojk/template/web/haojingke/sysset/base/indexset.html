<!DOCTYPE html>
<html>
<link href="./resource/css/bootstrap.min.css?v=20170719" rel="stylesheet">
<link href="./resource/css/common.css?v=20170719" rel="stylesheet">
{template 'haojingke/common/header'}
<script type="text/javascript">
    if(navigator.appName == 'Microsoft Internet Explorer'){
        if(navigator.userAgent.indexOf("MSIE 5.0")>0 || navigator.userAgent.indexOf("MSIE 6.0")>0 || navigator.userAgent.indexOf("MSIE 7.0")>0) {
            alert('您使用的 IE 浏览器版本过低, 推荐使用 Chrome 浏览器或 IE8 及以上版本浏览器.');
        }
    }
    window.sysinfo = {
    {if !empty($_W['uniacid'])}'uniacid': '{$_W['uniacid']}',{/if}
    {if !empty($_W['acid'])}'acid': '{$_W['acid']}',{/if}
    {if !empty($_W['openid'])}'openid': '{$_W['openid']}',{/if}
    {if !empty($_W['uid'])}'uid': '{$_W['uid']}',{/if}
    'isfounder': {if !empty($_W['isfounder'])}1{else}0{/if},
        'siteroot': '{$_W['siteroot']}',
            'siteurl': '{$_W['siteurl']}',
            'attachurl': '{$_W['attachurl']}',
            'attachurl_local': '{$_W['attachurl_local']}',
            'attachurl_remote': '{$_W['attachurl_remote']}',
            'module' : {'url' : '{if defined('MODULE_URL')}{MODULE_URL}{/if}', 'name' : '{if defined('IN_MODULE')}{IN_MODULE}{/if}'},
        'cookie' : {'pre': '{$_W['config']['cookie']['pre']}'},
        'account' : {php echo json_encode($_W['account'])},
    };
</script>
<style>
    .layui-table img {
        max-width: 300px;
    }
    .layui-table td, .layui-table th {
        position: relative;
        padding: 0px 0px;
        min-height: auto;
        line-height: 0px;
        font-size: 14px;
        border: 0px solid #e2e2e2;
        cursor:move;
    }
    .layui-table {
     width: auto; 
        margin: 10px 0;
        background-color: #fff;
    }
    .itemtitle{margin: 10px 60px;font-size:15px;color:gray}
    .layui-input-block {
        margin-left: 20px;
        min-height: 36px;
    }
    .label40{width:40px;}
    .height28{
    height: 28px;
    line-height: 28px;
}
.layui-input-inline input[type=checkbox], .layui-form input[type=radio], .layui-form select {
    display: block;
}
</style>
    <body>
        <div class="x-body">
            <blockquote class="layui-elem-quote">默认首页设置</blockquote>
            
            <div action="" method="post"class="layui-form"  enctype="multipart/form-data"  >
        </div>
            <div class="layui-tab layui-tab-card" id="setForm" style="float:left;width:45%;display:none;">
                <ul class="layui-tab-title">
                  <li class="layui-this">默认首页设置</li>
                  
                </ul>
                <div class="layui-tab-content" style="height: auto;">

                    <form action="" method="post" id="saveform"  enctype="multipart/form-data" class="layui-form">
                        <input type="hidden" id="menu_tpl" name="menu_tpl" value="diy_bottom"/>
                        <div class="layui-form" action="" id="headmenu_view">
                                    
                        </div>
                        <br/>
                        <button  type="submit" class="layui-btn" lay-filter="add" lay-submit="">
                            保存
                        </button>
                    </form>
                </div>
              </div>  
                
        </div>
    </body>
</html>

<script>var require = { urlArgs: 'v=20170915' };</script>
<script type="text/javascript" src="./resource/js/lib/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="./resource/js/lib/bootstrap.min.js"></script>
<script type="text/javascript" src="./resource/js/app/util.js?v=20170719"></script>
<script type="text/javascript" src="./resource/js/app/common.min.js?v=20170719"></script>
<script type="text/javascript" src="./resource/js/require.js?v=20170719"></script>
<script type="text/javascript" src="{NETS_HAOJIK_WEB_STYLE}js/jquery.nestable.js"></script>
<script language='javascript'>
    var recordjson={$jsonrecord};
    var diypage_html="{$global['homepage_itemhtml']}"
    var menutype="tab_menu";
    var recordlist=recordjson;
    var homepage_status="{$global['homepage_status']}"
    var emptyjson='{"ad_menu_name": "","itemtitle": "","itemremark": "","sort": 0,"list": [{"img": "","name": "","outer_url": "","url": ""}]}';
    var urltemparr=[];
    var formsubmiturl="{php echo webUrl('sysset/diypage/diyfoot_save',array('cloum'=>'PcloumP'));}";
    $(function () {
        if(diypage_html!=""){
            //$("#tbody").html(diypage_html);
        }
        
        //getPageitem();
        
    });
    $(document).ready(function(){
        bindEvents();
        get_tabmenu();
        $(".layui-form-radio").click(function(){
            $("#menu_tpl").val($(this).attr("tpl"));
            $(".layui-form-radio").toggleClass("layui-form-radioed");
        });
        
    });
    
    function bindEvents() {
        require(['jquery.ui'] ,function(){
            $("#tbody").sortable({handle: '.btn-move',axis: 'y'});
        });
        require(['jquery', 'util'], function ($, util) {
            // $('.btn-select-pic').unbind('click').click(function () {
            //     var imgitem = $(this).closest('.img-item');
            //     util.image('', function (data) {
            //         imgitem.find('img').attr('src', data['url']);
            //         imgitem.find('input').val(data['attachment']);
            //     });
            // });
        });
        inititemclick();
    }
    function additem(){
        var outhtml=$("#headmenu_view div.layui-form-item:eq(0)").prop("outerHTML");
        
        $("#headmenu_view").append(outhtml);
        bindEvents();
    }
    function removeItem(obj){
        $(obj).parent().parent().remove();
    }
    function getX(e) {
        e = e || window.event;
        return e.pageX || e.clientX + document.body.scroolLeft;
    }
    function getY(e) {
        e = e|| window.event;
        return e.pageY || e.clientY + document.boyd.scrollTop;
    }
    function HTMLEncode(html) 
    { 
    var temp = document.createElement ("div"); 
    (temp.textContent != null) ? (temp.textContent = html) : (temp.innerText = html); 
    var output = temp.innerHTML; 
    temp = null; 
    return output; 
    } 
    function HTMLDecode(text) 
    { 
    var temp = document.createElement("div"); 
    temp.innerHTML = text; 
    var output = temp.innerText || temp.textContent; 
    temp = null; 
    return output; 
    } 
    function savePageitem(){
        var itemArr=new Array();
        $("input[name='itemjson']").each(function(){
            var item=$(this);
            var itemobj=new Object();
            itemobj.datatype=item.attr("datatype");
            itemobj.dataname=item.attr("name");
            itemobj.sort=0;
            itemobj.isshow=item.attr(':checked')==undefined?true:false;
            
            itemArr.push(itemobj);
        });
        var loadii = layer.load();
        
        var pageitem=new Object();
        pageitem.title=$("#pagetitle").val();
        pageitem.pageitemjson=itemArr;
        var pagehtml=new Object();
        pagehtml.value=$("#tbody").html()
        pageitem.pageitemhtml=pagehtml;
        $.post("{php echo webUrl('sysset/diypage/savepageitem');}",pageitem,function(res){
                var res=JSON.parse(res);
                layer.close(loadii);
                if(res.status==1){
                    layer.alert(res.result.message, {icon: 6,closeBtn: 0},function () {
                        location.href=location.href;
                    });
                }else{
                    layer.msg("操作失败");
                }
        });
        
        console.log(itemArr);
    }
    function getPageitem(){
        var itemArr=new Array();
        $.post("{php echo webUrl('sysset/diypage/getpageitem');}",function(res){
                if(res=="" || res==null){
                    return;
                }
                var res=JSON.parse(res);
                $("#pagetitle").val(res.title);
                var htmlitem=res.itemhtml;
                var html=JSON.parse(htmlitem).value;
                html=HTMLDecode(html);
                $("#tbody").html(html);
                bindEvents();
                res=JSON.parse(res.itemjson);
                console.log(res);
                for(var i=0;i<res.length;i++){
                    if(res[i].isshow=="false"){
                        $("input[name='itemjson']").each(function(){
                            var item=$(this);
                            if(res[i].datatype==item.attr("datatype")){
                                console.log(res[i].datatype+"_"+item.attr("datatype"));
                                item.removeAttr("checked");
                                item.parent().find(".layui-form-checked").eq(0).removeClass("layui-form-checked");
                            }
                        });    
                    }
                }
        });
        bindEvents();
        console.log(itemArr);
    }
    
    layui.use(['form','layer'], function(){
            $ = layui.jquery;
            var form = layui.form
                ,layer = layui.layer;
            //监听提交
            form.on('submit(add1)', function(data){
                var action_formsubmiturl=formsubmiturl.replace("PcloumP",menutype);
                //$("#saveform").attr("action",action_formsubmiturl);
                //$("#saveform").submit();
                //return false;
            });
            form.on('submit(add)', function(data){
                //var action_formsubmiturl=formsubmiturl.replace("PcloumP",menutype);
                //$("#saveform").attr("action",action_formsubmiturl);
                //$("#saveform").submit();
                //return false;
            });
        });
    
</script>

<script>
    function  inititemclick(){
        
        layui.use('laytpl', function(){
            var laytpl = layui.laytpl;
            console.log("初始化事件");
            $(".layui-form-checkbox").unbind("click").click(function(){
                console.log(123);
                $(".layui-form-checkbox").attr("class","layui-unselect layui-form-checkbox");
                $(".layui-form-checkbox input").attr("checked",false);
                var item=$(this).parent().find("input").eq(0);
                item.attr("checked",true);
                console.log(item);
                var isshow=item.attr("checked");
                console.log(isshow);
                if(isshow==undefined){
                    console.log("显示");
                    //$(this).parent().parent().parent().parent().find("img").show();
                    //item.removeAttr("checked");
                    //item.attr("checked",true);
                }else{
                    console.log("隐藏");
                    //$(this).parent().parent().parent().parent().find("img").hide();
                    //item.attr("checked",false);
                }
            });
            $(".usemenu").unbind("click").click(function(){
                //console.log(getY());
                menutype=$(this).attr("data-type");
                
                if(menutype==""){
                    $("#setForm").hide();
                    return;
                }
                get_tabmenu();
            });
        });
    }
    function get_tabmenu(){
        layui.use('laytpl', function(){
            var laytpl = layui.laytpl;
        if(menutype==""){
                    $("#setForm").hide();
                    return;
                }
                $("#setForm").show();
                
                if($(this).attr("data-type")!=""){
                    
                    $.post("{php echo webUrl('sysset/diypage/getglobal');}&cloum="+menutype,function(res){
                        
                        if(res==null || res=="" || typeof(res)=='undefined' || res=="null"){
                            res=emptyjson;
                        }
                        
                        var obj=JSON.parse(res);
                        var menu_tpl_temp=obj.menu_tpl;
                        if(obj.list==null || obj.list=="" || obj.list=="undefined"){
                            res=emptyjson;
                            obj=JSON.parse(res);
                            obj.menu_tpl=menu_tpl_temp;
                        }
                        if(obj.menu_tpl=="" || obj.menu_tpl==undefined || obj.menu_tpl==null){
                            obj.menu_tpl="diy_bottom";
                        }
                        console.log(obj);
                        $("#menu_tpl").val(obj.menu_tpl);
                        $(".layui-form-radio").removeClass("layui-form-radioed");

                        $("#"+obj.menu_tpl).addClass("layui-form-radioed");
                        var list=obj.list;
                        console.log(list);
                        if(typeof obj.itemtitle!=undefined){
                            $("input[name='itemtitle']").val(obj.itemtitle);
                        }
                        if(typeof obj.itemremark!=undefined){
                            $("input[name='itemremark']").val(obj.itemremark);
                        }
                        var getTpl = $("#headmenu").html()
                        ,view =$('#headmenu_view');
                        laytpl(getTpl).render(list, function(html){
                            view.html(html);
                            bindEvents();
                        });    
                    });
                }
        });
    }
    </script>

<script id="headmenu" type="text/html">
    <div class="layui-form-item">
            <div class="layui-inline">
                  <label class="layui-form-label img-item">
                      
                  </label>
            </div>
            <div class="layui-inline">
              
              
              <label class="layui-form-label label40">链接</label>
              <div class="layui-input-inline">
                    <select type="text"   name="homepage_status" class="form-control valid"  placeholder="">
                            {if $_W["wxappauth"]=="1" || $_W["wxgzhauth"]=="1"}
                            <optgroup label="京东页面">
                                    <option {{#  if(homepage_status ===  '../choiceness/index?name=index'){ }}selected="selected"{{#  } }} value="../choiceness/index?name=index">京东首页</option>
                                    <option {{#  if(homepage_status === '../choiceness/index?name=choiceness'){ }}selected="selected"{{#  } }} value="../choiceness/index?name=choiceness">好券精选</option>
                                    <option {{#  if(homepage_status === '../choiceness/index?name=bigsearch'){ }}selected="selected"{{#  } }} value="../choiceness/index?name=bigsearch">超级搜索</option>
                                    <option {{#  if(homepage_status === '../choiceness/index?name=好货情报局'){ }}selected="selected"{{#  } }} value="../choiceness/index?name=好货情报局">好货情报局</option>
                                    <option {{#  if(homepage_status === '../choiceness/index?name=砍价'){ }}selected="selected"{{#  } }}  value="../choiceness/index?name=砍价">砍价</option>
                                    <option {{#  if(homepage_status ===  '../choiceness/index?name=拼购'){ }}selected="selected"{{#  } }} value="../choiceness/index?name=拼购">拼购</option>
                                    <option {{#  if(homepage_status ===  '../choiceness/index?name=榜单'){ }}selected="selected"{{#  } }} value="../choiceness/index?name=榜单">榜单</option>
                                    <option {{#  if(homepage_status ===  '../choiceness/index?name=2小时跑单'){ }}selected="selected"{{#  } }} value="../choiceness/index?name=2小时跑单">2小时跑单</option>
                                    <option {{#  if(homepage_status ===  '../choiceness/index?name=全天销售榜'){ }}selected="selected"{{#  } }} value="../choiceness/index?name=全天销售榜">全天销售榜</option>
                                    <option {{#  if(homepage_status ===  '../choiceness/index?name=实时排行榜'){ }}selected="selected"{{#  } }} value="../choiceness/index?name=实时排行榜">实时排行榜</option>
                            </optgroup>
                            {/if}
                            {if $_W["wxpddauth"]=="1"}
                            <optgroup label="拼多多页面">
                                <option {{#  if(homepage_status ===  '../choiceness/index?name=pddindex'){ }}selected="selected"{{#  } }} value="../choiceness/index?name=pddindex">拼多多首页</option>
                                <option {{#  if(homepage_status === '../choiceness/index?name=pddsearch'){ }}selected="selected"{{#  } }} value="../choiceness/index?name=pddsearch">搜索列表页</option>
                            </optgroup>
                            {/if}
                            {if $_W["wxgwqauth"]=="1"}
                            <optgroup label="购物圈页面">
                                <option {{#  if(homepage_status ===  '../choiceness/index?name=gwqindex'){ }}selected="selected"{{#  } }} value="../choiceness/index?name=gwqindex">购物圈首页</option>
                                <option {{#  if(homepage_status === '../choiceness/index?name=gwqsearch'){ }}selected="selected"{{#  } }} value="../choiceness/index?name=gwqsearch">购物圈搜索</option>
                                <option {{#  if(homepage_status === '../choiceness/index?name=gwqfriend'){ }}selected="selected"{{#  } }} value="../choiceness/index?name=gwqfriend">购物圈好友</option>
                            </optgroup>
                            {/if}
                            <optgroup label="会员中心">
                                <option {{#  if(homepage_status === '../choiceness/index?name=my'){ }}selected="selected"{{#  } }} value="../choiceness/index?name=my">我的</option>
                            </optgroup>
                            
                    </select>
              </div>
              
            </div>
          </div>
  </script>

  